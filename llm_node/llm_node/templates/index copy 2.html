<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì±„íŒ… ì„œë¹„ìŠ¤</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#f5f6f7; font-family:'Noto Sans KR', Arial, sans-serif; color:#222; overflow:hidden; }
    #robotChatScreen { position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .chat-bg { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; opacity:0.36; z-index:0; pointer-events:none; }

    .chat-container { position:relative; z-index:1; width:100%; max-width:520px; height:90vh; max-height:800px; background:rgba(255,255,255,0.85); backdrop-filter:blur(10px); border-radius:22px; box-shadow:0 4px 32px rgba(0,0,0,0.1); display:flex; flex-direction:column; overflow:hidden; }
    .chat-header { padding:16px 18px; font-size:1.05rem; font-weight:600; border-bottom:1px solid #e8e8e8; display:flex; justify-content:space-between; align-items:center; }
    .status-chip { font-size:.85rem; padding:6px 10px; border-radius:999px; border:1px solid #e4e4ea; background:#f8f8fb; transition:background .2s,border-color .2s,color .2s; }
    .status-chip.busy { background:#ff4d4d; border-color:#d60000; color:#fff; }   /* ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    .status-chip.done { background:#d8f5d2; border-color:#95d58b; }
    .chat-messages { flex:1 1 0; overflow-y:auto; padding:16px 12px 8px 12px; display:flex; flex-direction:column; gap:12px; }
    .message-row { display:flex; align-items:flex-end; }
    .message { padding:11px 16px; font-size:1rem; line-height:1.4; max-width:75%; word-wrap:break-word; }
    .message.you { margin-left:auto; background:#ffe34d; color:#252525; border-radius:18px 18px 5px 18px; }
    .message.bot { margin-right:auto; background:#f8f8fa; color:#222; border-radius:18px 18px 18px 5px; border:1.2px solid #e2e2ea; }
    .chat-inputbar { padding:12px; background:#f7f7f8; display:flex; gap:10px; border-top:1px solid #e4e3e8; align-items:center; }
    .chat-input { flex:1 1 0; border:1px solid #ddd; border-radius:18px; padding:12px 16px; font-size:1rem; background:#fff; color:#222; outline:none; transition:border-color .2s; }
    .chat-input:focus { border-color:#ffcb03; }
    .send-btn { background:#ffde3b; color:#333; border:none; border-radius:50%; width:44px; height:44px; font-weight:bold; cursor:pointer; font-size:1.3rem; display:flex; align-items:center; justify-content:center; transition:background .15s; }
    .send-btn:hover { background:#ffcb03; }
    .stt-toggle { display:flex; align-items:center; margin-left:4px; }
    .stt-toggle input { display:none; }
    .stt-toggle label { position:relative; width:48px; height:28px; border:1px solid #ddd; border-radius:999px; cursor:pointer; background:#f1f1f4; display:inline-block; }
    .stt-toggle .mic { position:absolute; top:2px; left:2px; width:24px; height:24px; line-height:24px; text-align:center; font-size:14px; background:#fff; border:1px solid #ddd; border-radius:50%; transition:left .18s ease; }
    .stt-toggle input:checked + label { background:#ffde3b; border-color:#ffde3b; }
    .stt-toggle input:checked + label .mic { left:22px; }
    @media (max-width:540px){ .chat-container{ width:100vw; height:100vh; max-height:100%; border-radius:0; box-shadow:none; } }
  </style>
</head>
<body>
  <div id="robotChatScreen">
    <img class="chat-bg" src="{{ url_for('static', filename='s1.png') }}" alt="ì±„íŒ… ë°°ê²½" onerror="this.style.display='none'">
    <div class="chat-container">
      <div class="chat-header">
        <span>ì±„íŒ… ì„œë¹„ìŠ¤</span>
        <span id="statusChip" class="status-chip">ëŒ€ê¸° ì¤‘</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message-row"><div class="message bot">ë¡œë´‡ ëŒ€ê¸° ì¤‘</div></div>
      </div>

      <form class="chat-inputbar" id="chatForm" autocomplete="off">
        <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”..." required />
        <button type="submit" class="send-btn">â–¶</button>
        <div class="stt-toggle">
          <input type="checkbox" id="sttSwitch" />
          <label for="sttSwitch" title="STT On/Off"><span class="mic">ðŸŽ¤</span></label>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const sttSwitch = document.getElementById('sttSwitch');
    const statusChip = document.getElementById('statusChip');
    const STT_SECONDS = 5;

    const sock = io();
    let ROBOT_STATE = 'idle';   // idle | busy | done
    let doneTimer = null;

    function setState(s) {
      if (ROBOT_STATE === 'busy' && s === 'idle') return; // busyì¼ ë•Œ ëŒ€ê¸°ì¤‘ìœ¼ë¡œ ë³€ê²½ ê¸ˆì§€
      ROBOT_STATE = s;
      statusChip.classList.remove('busy', 'done');
      if (s === 'idle') {
        statusChip.textContent = 'ëŒ€ê¸° ì¤‘';
      } else if (s === 'busy') {
        statusChip.textContent = 'ìž‘ì—… ì¤‘';
        statusChip.classList.add('busy');  // ë¹¨ê°„ìƒ‰ í‘œì‹œ
        if (doneTimer) { clearTimeout(doneTimer); doneTimer = null; }
      } else if (s === 'done') {
        statusChip.textContent = 'ìž‘ì—… ì™„ë£Œ';
        statusChip.classList.add('done');
        doneTimer = setTimeout(() => setState('idle'), 2000);
      }
    }

    // /tool_chat/in â†’ you
    sock.on('incoming_text', (p) => {
      const t = (p && p.text ? String(p.text) : '').trim();
      if (t) appendMessage('you', t);
    });

    // /tool_chat/out â†’ bot
    sock.on('external_chat_response', (p) => {
      if (p && p.response) {
        setState('busy');
        appendMessage('bot', p.response);
      }
    });

    // /tts_status â†’ busy ìœ ì§€
    sock.on('tts_status', (p) => {
      const playing = !!(p && p.status && p.status.playing);
      if (playing) setState('busy');
    });

    // /task/done â†’ ì™„ë£Œ â†’ 2ì´ˆ í›„ ëŒ€ê¸°
    sock.on('task_done', () => setState('done'));

    // STT ê²°ê³¼
    sock.on('stt_result', (p) => {
      const text = (p && p.recognized_text ? String(p.recognized_text) : '').trim();
      if (text) appendMessage('you', text);
      else appendMessage('bot', 'ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    });

    // ìž…ë ¥ ì „ì†¡
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;
      appendMessage('you', userMessage);
      chatInput.value = '';
      try {
        await fetch('/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ message:userMessage })
        }).then(r=>r.json()).catch(()=>({}));
      } catch { appendMessage('bot', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜'); }
    });

    function appendMessage(type, text) {
      const row = document.createElement('div'); row.className = 'message-row';
      const msg = document.createElement('div'); msg.className = 'message ' + type; msg.textContent = text;
      row.appendChild(msg); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function fetchJSON(url, opt) {
      const r = await fetch(url, opt || {}); if (!r.ok) throw new Error(String(r.status));
      const ct = r.headers.get('content-type') || ''; return ct.includes('application/json') ? r.json() : {};
    }

    // STT í´ë§ ìœ ì§€
    let pollTimer=null, polling=false, sttStarting=false, backoffMs=1000;
    async function startSTT() {
      if (sttStarting) return;
      sttStarting = true;
      try {
        await fetchJSON('/stt/start', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ duration:STT_SECONDS }) });
        backoffMs = 1000;
      } catch { backoffMs = Math.min(backoffMs*2, 15000); }
      sttStarting = false;
    }
    async function pollStatus() {
      if (polling) return;
      polling = true;
      try {
        const s = await fetchJSON('/status');
        const rec = !!(s.stt_info && s.stt_info.recording);
        if (sttSwitch.checked && !rec) await startSTT();
        scheduleNext(backoffMs);
      } catch {
        backoffMs = Math.min(backoffMs*2, 15000);
        scheduleNext(backoffMs);
      } finally { polling = false; }
    }
    function scheduleNext(ms){ clearTimeout(pollTimer); pollTimer=setTimeout(()=>{ if(document.visibilityState==='visible') pollStatus(); }, ms); }
    sttSwitch.addEventListener('change', ()=>{ if (sttSwitch.checked) startSTT(); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') scheduleNext(200); else clearTimeout(pollTimer); });
    window.addEventListener('beforeunload', ()=> clearTimeout(pollTimer));
    scheduleNext(400);
  </script>
</body>
</html>
